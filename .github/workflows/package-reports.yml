---
name: Package Reports

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Upload DAKKS-SAMPLE as artifact
        uses: actions/upload-artifact@v4
        with:
          name: DAKKS-SAMPLE
          path: |
            DAKKS-SAMPLE/main_reports
            DAKKS-SAMPLE/subreports
          if-no-files-found: error

      - name: Upload DCC as artifact
        uses: actions/upload-artifact@v4
        with:
          name: DCC
          path: |
            DCC/main_reports
            DCC/subreports
          if-no-files-found: error

      - name: Upload FIELD-NAMES as artifact
        uses: actions/upload-artifact@v4
        with:
          name: FIELD-NAMES
          path: |
            FIELD-NAMES/main_reports
            FIELD-NAMES/subreports
          if-no-files-found: error

      - name: Upload ORDER-SAMPLE as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ORDER-SAMPLE
          path: |
            ORDER-SAMPLE/main_reports
            ORDER-SAMPLE/subreports
          if-no-files-found: error

      - name: Upload INVENTORY-SAMPLE as artifact
        uses: actions/upload-artifact@v4
        with:
          name: INVENTORY-SAMPLE
          path: |
            INVENTORY-SAMPLE/main_reports
            INVENTORY-SAMPLE/subreports
          if-no-files-found: error

      - name: Upload DELIVERY-STANDALONE as artifact
        uses: actions/upload-artifact@v4
        with:
          name: DELIVERY-STANDALONE
          path: |
            DELIVERY-STANDALONE/main_reports
            DELIVERY-STANDALONE/subreports
          if-no-files-found: error

      - name: List files before zipping (Debug)
        run: |
          echo "ðŸ“‚ Inhalt von DAKKS-SAMPLE:"
          find DAKKS-SAMPLE
          echo "ðŸ“‚ Inhalt von DCC:"
          find DCC
          echo "ðŸ“‚ Inhalt von FIELD-NAMES:"
          find FIELD-NAMES
          echo "ðŸ“‚ Inhalt von ORDER-SAMPLE:"
          find ORDER-SAMPLE
          echo "ðŸ“‚ Inhalt von INVENTORY-SAMPLE:"
          find INVENTORY-SAMPLE
          echo "ðŸ“‚ Inhalt von DELIVERY-STANDALONE:"
          find DELIVERY-STANDALONE

      - name: Create ZIPs of all folders (JRXML, plus properties/MD for DAKKS)
        run: |
          set -euo pipefail

          mkdir -p zip_output staging

          create_zip() {
            local sample="$1"
            local zip_name="$2"
            local stage_dir="staging/${zip_name}"
            local rsync_excludes=()
            local allowed_patterns=('*.jrxml')
            local include_args=(--include='*/')

            if [ "$sample" = "DAKKS-SAMPLE" ]; then
              rsync_excludes+=(--exclude='config/**')
              allowed_patterns+=('*.properties' '*.md')
            elif [ "$sample" = "DCC" ]; then
              allowed_patterns+=('*.xsd' '*.md' '*.json')
            fi

            rm -rf "${stage_dir}"
            mkdir -p "${stage_dir}"
            mkdir -p "${stage_dir}/main_reports" "${stage_dir}/subreports"

            for pattern in "${allowed_patterns[@]}"; do
              include_args+=(--include="$pattern")
            done
            include_args+=(--exclude='*')

            for folder in main_reports subreports; do
              if [ -d "${sample}/${folder}" ]; then
                rsync -av "${rsync_excludes[@]}" "${include_args[@]}" \
                  "${sample}/${folder}/" "${stage_dir}/${folder}/"
              fi
            done

            # Nicht erlaubte Dateien entfernen, damit nur die gewÃ¼nschten Typen
            # (JRXML und ggf. Properties/Markdown) enthalten bleiben.
            local allowed_conditions=()
            for pattern in "${allowed_patterns[@]}"; do
              allowed_conditions+=(-name "$pattern" -o)
            done
            unset 'allowed_conditions[${#allowed_conditions[@]}-1]'
            find "${stage_dir}" -type f ! \( "${allowed_conditions[@]}" \) -delete

            if [ -z "$(find "${stage_dir}" -type f -name '*.jrxml' -print -quit)" ]; then
              echo "âŒ No JRXML files found in ${sample}" >&2
              exit 1
            fi

            pushd "${stage_dir}" >/dev/null
            if [ -d main_reports ] && [ -d subreports ]; then
              zip -r "../../zip_output/${zip_name}.zip" main_reports subreports
            elif [ -d main_reports ]; then
              zip -r "../../zip_output/${zip_name}.zip" main_reports
            elif [ -d subreports ]; then
              zip -r "../../zip_output/${zip_name}.zip" subreports
            else
              echo "âŒ No report folders found for ${sample}" >&2
              popd >/dev/null
              exit 1
            fi
            popd >/dev/null
          }

          create_zip "DAKKS-SAMPLE" "dakks-sample"
          create_zip "DCC" "dcc-sample"
          create_zip "FIELD-NAMES" "field-names"
          create_zip "ORDER-SAMPLE" "order-sample"
          create_zip "INVENTORY-SAMPLE" "inventory-sample"
          create_zip "DELIVERY-STANDALONE" "delivery-standalone"

      - name: Show ZIP contents (Debug)
        run: |
          unzip -l zip_output/dakks-sample.zip
          unzip -l zip_output/dcc-sample.zip
          unzip -l zip_output/field-names.zip
          unzip -l zip_output/order-sample.zip
          unzip -l zip_output/inventory-sample.zip
          unzip -l zip_output/delivery-standalone.zip

      - name: Send DAKKS-SAMPLE ZIP to API
        env:
          DOMAIN: ${{ secrets.DOMAIN }}
          HTTP_X_REST_USERNAME: ${{ secrets.HTTP_X_REST_USERNAME }}
          HTTP_X_REST_PASSWORD: ${{ secrets.HTTP_X_REST_PASSWORD }}
          HTTP_X_REST_API_KEY: ${{ secrets.HTTP_X_REST_API_KEY }}
        run: |
          REPORT_URL="https://${DOMAIN}/api/report/20f5a9a6-294d-71e5-36f1-c81bea82a615"
          QUERY="HTTP_X_REST_USERNAME=${HTTP_X_REST_USERNAME}&"
          QUERY+="HTTP_X_REST_PASSWORD=${HTTP_X_REST_PASSWORD}&"
          QUERY+="HTTP_X_REST_API_KEY=${HTTP_X_REST_API_KEY}"
          curl -X POST "$REPORT_URL?$QUERY" \
            -F "file=@zip_output/dakks-sample.zip"

      - name: Send DCC ZIP to API
        env:
          DOMAIN: ${{ secrets.DOMAIN }}
          HTTP_X_REST_USERNAME: ${{ secrets.HTTP_X_REST_USERNAME }}
          HTTP_X_REST_PASSWORD: ${{ secrets.HTTP_X_REST_PASSWORD }}
          HTTP_X_REST_API_KEY: ${{ secrets.HTTP_X_REST_API_KEY }}
        run: |
          REPORT_URL="https://${DOMAIN}/api/report/517d5a02-281b-4564-95c0-bdaf3cab5604"
          QUERY="HTTP_X_REST_USERNAME=${HTTP_X_REST_USERNAME}&"
          QUERY+="HTTP_X_REST_PASSWORD=${HTTP_X_REST_PASSWORD}&"
          QUERY+="HTTP_X_REST_API_KEY=${HTTP_X_REST_API_KEY}"
          curl -X POST "$REPORT_URL?$QUERY" \
            -F "file=@zip_output/dcc-sample.zip"

      - name: Send ORDER-SAMPLE ZIP to API
        env:
          DOMAIN: ${{ secrets.DOMAIN }}
          HTTP_X_REST_USERNAME: ${{ secrets.HTTP_X_REST_USERNAME }}
          HTTP_X_REST_PASSWORD: ${{ secrets.HTTP_X_REST_PASSWORD }}
          HTTP_X_REST_API_KEY: ${{ secrets.HTTP_X_REST_API_KEY }}
        run: |
          REPORT_URL="https://${DOMAIN}/api/report/bbf1a0d1-8fbb-6d89-c966-156451250ef3"
          QUERY="HTTP_X_REST_USERNAME=${HTTP_X_REST_USERNAME}&"
          QUERY+="HTTP_X_REST_PASSWORD=${HTTP_X_REST_PASSWORD}&"
          QUERY+="HTTP_X_REST_API_KEY=${HTTP_X_REST_API_KEY}"
          curl -X POST "$REPORT_URL?$QUERY" \
            -F "file=@zip_output/order-sample.zip"

      - name: Send INVENTORY-SAMPLE ZIP to API
        env:
          DOMAIN: ${{ secrets.DOMAIN }}
          HTTP_X_REST_USERNAME: ${{ secrets.HTTP_X_REST_USERNAME }}
          HTTP_X_REST_PASSWORD: ${{ secrets.HTTP_X_REST_PASSWORD }}
          HTTP_X_REST_API_KEY: ${{ secrets.HTTP_X_REST_API_KEY }}
        run: |
          REPORT_URL="https://${DOMAIN}/api/report/ff64a5c7-f592-a871-5dbb-6dc24bff9bbd"
          QUERY="HTTP_X_REST_USERNAME=${HTTP_X_REST_USERNAME}&"
          QUERY+="HTTP_X_REST_PASSWORD=${HTTP_X_REST_PASSWORD}&"
          QUERY+="HTTP_X_REST_API_KEY=${HTTP_X_REST_API_KEY}"
          curl -X POST "$REPORT_URL?$QUERY" \
            -F "file=@zip_output/inventory-sample.zip"

      - name: Send FIELD-NAMES ZIP to API
        env:
          DOMAIN: ${{ secrets.DOMAIN }}
          HTTP_X_REST_USERNAME: ${{ secrets.HTTP_X_REST_USERNAME }}
          HTTP_X_REST_PASSWORD: ${{ secrets.HTTP_X_REST_PASSWORD }}
          HTTP_X_REST_API_KEY: ${{ secrets.HTTP_X_REST_API_KEY }}
        run: |
          REPORT_URL="https://${DOMAIN}/api/report/94b42cc6-a66e-b633-bf71-5d29756ff023"
          QUERY="HTTP_X_REST_USERNAME=${HTTP_X_REST_USERNAME}&"
          QUERY+="HTTP_X_REST_PASSWORD=${HTTP_X_REST_PASSWORD}&"
          QUERY+="HTTP_X_REST_API_KEY=${HTTP_X_REST_API_KEY}"
          curl -X POST "$REPORT_URL?$QUERY" \
            -F "file=@zip_output/field-names.zip"

      - name: Send DELIVERY-STANDALONE ZIP to API
        env:
          DOMAIN: ${{ secrets.DOMAIN }}
          HTTP_X_REST_USERNAME: ${{ secrets.HTTP_X_REST_USERNAME }}
          HTTP_X_REST_PASSWORD: ${{ secrets.HTTP_X_REST_PASSWORD }}
          HTTP_X_REST_API_KEY: ${{ secrets.HTTP_X_REST_API_KEY }}
        run: |
          REPORT_URL="https://${DOMAIN}/api/report/ab625419-31d4-8603-1cb3-f768af3b9fb0"
          QUERY="HTTP_X_REST_USERNAME=${HTTP_X_REST_USERNAME}&"
          QUERY+="HTTP_X_REST_PASSWORD=${HTTP_X_REST_PASSWORD}&"
          QUERY+="HTTP_X_REST_API_KEY=${HTTP_X_REST_API_KEY}"
          curl -X POST "$REPORT_URL?$QUERY" \
            -F "file=@zip_output/delivery-standalone.zip"
