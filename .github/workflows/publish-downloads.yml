---
name: Publish Downloads

on:
  workflow_run:
    workflows: ["Package Reports"]
    types: [completed]
  workflow_dispatch:
    inputs:
      run_id:
        description: "Workflow run ID for the artifacts to publish"
        required: true
        type: string
      run_number:
        description: "Workflow run number for metadata"
        required: false
        type: string
      commit_sha:
        description: "Commit SHA for metadata"
        required: false
        type: string
      workflow_name:
        description: "Workflow name for metadata"
        required: false
        type: string

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  publish:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
      actions: read
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download report ZIP artifacts from build
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.workflow_run.id || github.event.inputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          name: report-zips
          path: artifacts/report-zips

      - name: Validate downloaded artifacts
        run: |
          set -euo pipefail

          if [ ! -d artifacts ]; then
            echo "ERROR: artifacts/ directory was not created by actions/download-artifact."
            exit 1
          fi

          if ! find artifacts -mindepth 1 -maxdepth 1 -type d | grep -q .; then
            echo "ERROR: artifacts/ contains no artifact subdirectories; aborting publish."
            exit 1
          fi

      - name: Collect last-modified dates
        run: |
          set -euo pipefail
          : > artifacts/last-modified.tsv

          get_last_modified() {
            local source_dir="$1"
            local zip_name="$2"
            local date
            date="$(git log -1 --format=%cI -- "${source_dir}")"
            if [ -z "$date" ]; then
              date="unknown"
            fi
            printf "%s\t%s\n" "${zip_name}" "${date}" >> artifacts/last-modified.tsv
          }

          get_last_modified "DAKKS-SAMPLE" "dakks-sample"
          get_last_modified "DCC" "dcc-sample"
          get_last_modified "FIELD-NAMES" "field-names"
          get_last_modified "ORDER-SAMPLE" "order-sample"
          get_last_modified "INVENTORY-SAMPLE" "inventory-sample"
          get_last_modified "DELIVERY-STANDALONE" "delivery-standalone"
          get_last_modified "STICKERS/CAL-INV-STICKER_Zebra-ZD621_30x15-203dpi" "sticker-cal-inv-zebra-zd621-30x15-203dpi"
          get_last_modified "STICKERS/CAL-STICKER_Zebra-ZD621_30x15-203dpi" "sticker-cal-zebra-zd621-30x15-203dpi"
          get_last_modified "STICKERS/DAKKS-Aufkleber_12mm" "sticker-dakks-aufkleber-12mm"
          get_last_modified "STICKERS/DAKKS-Aufkleber_18mm" "sticker-dakks-aufkleber-18mm"
          get_last_modified "STICKERS/INV-STICKER_Zebra-ZD621_30x15-203dpi" "sticker-inv-zebra-zd621-30x15-203dpi"
          get_last_modified "STICKERS/INV-CAL-LOC-STICKER_Zebra-ZD621_30x15-203dpi" "sticker-inv-cal-loc-zebra-zd621-30x15-203dpi"
          get_last_modified "STICKERS/Sticker_Vorlage" "sticker-vorlage"

          echo "Last-modified dates:"
          cat artifacts/last-modified.tsv

      - name: Build downloads site
        env:
          WORKFLOW_NAME: ${{ github.event.workflow_run.name || github.event.inputs.workflow_name }}
          RUN_ID: ${{ github.event.workflow_run.id || github.event.inputs.run_id }}
          RUN_NUMBER: ${{ github.event.workflow_run.run_number || github.event.inputs.run_number }}
          COMMIT_SHA: ${{ github.event.workflow_run.head_sha || github.event.inputs.commit_sha }}
        run: |
          set -euo pipefail

          SITE_DIR="site"
          DOWNLOADS_DIR="${SITE_DIR}/downloads"
          FILES_DIR="${DOWNLOADS_DIR}/files"
          METADATA_FILE="${DOWNLOADS_DIR}/metadata.tsv"

          rm -rf "${SITE_DIR}"
          mkdir -p "${FILES_DIR}"

          cp -R downloads/index.html downloads/assets "${DOWNLOADS_DIR}/"
          cp pages/index.html "${SITE_DIR}/index.html"
          touch "${SITE_DIR}/.nojekyll"

          : > "${METADATA_FILE}"
          shopt -s nullglob

          for zip_file in artifacts/report-zips/*.zip; do
            if [ -f "${zip_file}" ]; then
              filename="$(basename "${zip_file}")"
              artifact_name="${filename%.zip}"
              target_path="${GITHUB_WORKSPACE}/${FILES_DIR}/${filename}"
              cp "${zip_file}" "${target_path}"
              size_bytes="$(stat -c%s "${target_path}")"
              sha256="$(sha256sum "${target_path}" | awk '{print $1}')"
              printf "%s\t%s\t%s\t%s\n" "${artifact_name}" "${filename}" "${size_bytes}" "${sha256}" >> "${METADATA_FILE}"
            fi
          done

          if [ ! -s "${METADATA_FILE}" ]; then
            echo "ERROR: ${METADATA_FILE} is empty; no download metadata was generated."
            exit 1
          fi

          python - <<'PY'
          import json
          from datetime import datetime, timezone
          from pathlib import Path
          import os

          last_modified = {}
          lm_path = Path("artifacts/last-modified.tsv")
          if lm_path.exists():
              for line in lm_path.read_text().splitlines():
                  parts = line.split("\t")
                  if len(parts) == 2:
                      last_modified[parts[0]] = parts[1]

          metadata_path = Path("site/downloads/metadata.tsv")
          artifacts = []
          if metadata_path.exists():
              for line in metadata_path.read_text().splitlines():
                  name, filename, size_bytes, sha256 = line.split("\t")
                  artifacts.append(
                      {
                          "name": name,
                          "filename": filename,
                          "sizeBytes": int(size_bytes),
                          "sha256": sha256,
                          "url": f"files/{filename}",
                          "lastModified": last_modified.get(name),
                      }
                  )

          payload = {
              "generatedAt": datetime.now(timezone.utc).isoformat(),
              "workflow": os.environ.get("WORKFLOW_NAME"),
              "runId": os.environ.get("RUN_ID"),
              "runNumber": os.environ.get("RUN_NUMBER"),
              "commitSha": os.environ.get("COMMIT_SHA"),
              "artifacts": artifacts,
          }

          output_path = Path("site/downloads/latest.json")
          output_path.write_text(json.dumps(payload, indent=2))
          PY

      - name: Configure GitHub Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4
