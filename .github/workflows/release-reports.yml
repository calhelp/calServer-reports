---
name: Release Reports

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Optional custom tag name (leave empty for auto-generated tag)'
        required: false
        default: ''

jobs:
  build-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Create ZIP archives
        run: |
          set -euo pipefail

          mkdir -p output staging

          create_zip() {
            local sample="$1"
            local zip_name="$2"
            local stage_dir="staging/${zip_name}"
            local rsync_excludes=()
            local allowed_patterns=('*.jrxml')
            local include_args=(--include='*/')

            if [ "$sample" = "DAKKS-SAMPLE" ]; then
              rsync_excludes+=(--exclude='config/**')
              allowed_patterns+=('*.properties' '*.md')
            elif [ "$sample" = "DCC" ]; then
              allowed_patterns+=('*.xsd' '*.md' '*.json')
            fi

            rm -rf "${stage_dir}"
            mkdir -p "${stage_dir}"
            mkdir -p "${stage_dir}/main_reports" "${stage_dir}/subreports"

            for pattern in "${allowed_patterns[@]}"; do
              include_args+=(--include="$pattern")
            done
            include_args+=(--exclude='*')

            for folder in main_reports subreports; do
              if [ -d "${sample}/${folder}" ]; then
                rsync -av "${rsync_excludes[@]}" "${include_args[@]}" \
                  "${sample}/${folder}/" "${stage_dir}/${folder}/"
              fi
            done

            # Sicherstellen, dass nur explizit erlaubte Dateitypen in den ZIPs landen.
            local allowed_conditions=()
            for pattern in "${allowed_patterns[@]}"; do
              allowed_conditions+=(-name "$pattern" -o)
            done
            unset 'allowed_conditions[${#allowed_conditions[@]}-1]'
            find "${stage_dir}" -type f ! \( "${allowed_conditions[@]}" \) -delete

            if [ -d "${stage_dir}/subreports" ] \
              && [ -z "$(find "${stage_dir}/subreports" -type f -name '*.jrxml' -print -quit)" ]; then
              touch "${stage_dir}/subreports/.keep"
            fi

            if [ -z "$(find "${stage_dir}" -type f -name '*.jrxml' -print -quit)" ]; then
              echo "❌ No JRXML files found in ${sample}" >&2
              exit 1
            fi

            pushd "${stage_dir}" >/dev/null
            if [ -d main_reports ] && [ -d subreports ]; then
              zip -r "../../output/${zip_name}.zip" main_reports subreports
            elif [ -d main_reports ]; then
              zip -r "../../output/${zip_name}.zip" main_reports
            elif [ -d subreports ]; then
              zip -r "../../output/${zip_name}.zip" subreports
            else
              echo "❌ No report folders found for ${sample}" >&2
              popd >/dev/null
              exit 1
            fi
            popd >/dev/null
          }

          create_zip "DAKKS-SAMPLE" "dakks-sample"
          create_zip "DCC" "dcc-sample"
          create_zip "FIELD-NAMES" "field-names"
          create_zip "ORDER-SAMPLE" "order-sample"
          create_zip "INVENTORY-SAMPLE" "inventory-sample"
          create_zip "DELIVERY-STANDALONE" "delivery-standalone"
          create_zip "STICKERS/CAL-INV-STICKER_Zebra-ZD621_30x15-203dpi" "sticker-cal-inv-zebra-zd621-30x15-203dpi"
          create_zip "STICKERS/CAL-STICKER_Zebra-ZD621_30x15-203dpi" "sticker-cal-zebra-zd621-30x15-203dpi"
          create_zip "STICKERS/DAKKS-Aufkleber_12mm" "sticker-dakks-aufkleber-12mm"
          create_zip "STICKERS/DAKKS-Aufkleber_18mm" "sticker-dakks-aufkleber-18mm"
          create_zip "STICKERS/INV-STICKER_Zebra-ZD621_30x15-203dpi" "sticker-inv-zebra-zd621-30x15-203dpi"
          create_zip "STICKERS/INV-CAL-LOC-STICKER_Zebra-ZD621_30x15-203dpi" "sticker-inv-cal-loc-zebra-zd621-30x15-203dpi"
          create_zip "STICKERS/Sticker_Vorlage" "sticker-vorlage"

      - name: Determine release metadata
        id: release_meta
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ -n "${{ github.event.inputs.tag }}" ]; then
              TAG="${{ github.event.inputs.tag }}"
            else
              TAG="reports-$(date -u +'%Y%m%d-%H%M%S')"
            fi
          else
            TAG="${{ github.ref_name }}"
          fi

          NAME="Reports ${TAG}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "name=$NAME" >> "$GITHUB_OUTPUT"

      - name: Publish release on GitHub
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release_meta.outputs.tag }}
          name: ${{ steps.release_meta.outputs.name }}
          target_commitish: ${{ github.sha }}
          files: output/*.zip
          generate_release_notes: true
